---
name: Auto Merge and Delete Branch

"on":
  pull_request:
    types:
      - closed

permissions:
  contents: write

jobs:
  auto-merge-and-delete:
    runs-on: ubuntu-latest

    if: github.event.pull_request.merged == true

    steps:
      - name: Checkout repository
        uses: actions/checkout@ee0669bd1cc54295c223e0bb666b733df41de1c5

      - name: Validate and write branch name
        id: branch
        env:
          BRANCH_NAME: ${{ github.event.pull_request.head.ref }}
        run: |
          # Validate branch name format and write to file when valid
          python3 -c '
          import os, re
          name = os.environ.get("BRANCH_NAME", "") or ""
          if re.match(r"^[a-zA-Z0-9/_.-]+$", name) and name != "main":
            open("branch_name.txt", "w").write(name)
            print("valid=true", file=open(os.environ["GITHUB_OUTPUT"], "a"))
          else:
            print("valid=false", file=open(os.environ["GITHUB_OUTPUT"], "a"))
          '

      - name: Delete branch
        if: steps.branch.outputs.valid == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          branch_name=$(cat branch_name.txt)
          git push origin --delete "$branch_name"
